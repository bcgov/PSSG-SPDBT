using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Spd.Manager.ScheduleJob;
using Spd.Utilities.Shared;

namespace Spd.Presentation.Dynamics.Controllers;

/// <summary>
/// ScheduleJob support for dynamics
/// </summary>
[Authorize]
public class ScheduleJobController : SpdControllerBase
{
    private readonly IMediator _mediator;
    private readonly IConfiguration _configuration;

    public ScheduleJobController(IMediator mediator, IConfiguration configuration) : base()
    {
        _mediator = mediator;
        _configuration = configuration;
    }

    /// <summary>
    /// Run schedule job session
    /// </summary>
    /// <param name="sessionId">the GUID of schedule job session</param>
    /// <param name="ct">cancellation token, generated by dotnetcore</param>
    /// <response code="200">Ok</response>
    /// <response code="400">if the job session cannot be found</response>
    /// <returns>
    /// </returns>
    [HttpGet]
    [Route("api/schedule-job-session/{sessionId}/run")]
    public async Task<IActionResult> RunJobSessionAsync(
        [FromRoute] Guid sessionId,
        CancellationToken ct)
    {
        _mediator.Send(new RunScheduleJobSessionCommand(sessionId), ct);
        return Ok();
    }
}
